<!DOCTYPE html>

<html>

    <head>

        <meta charset="utf-8" />

        <title>Battleships</title>
        <script src="jquery-3.1.1.js"></script>
        <link rel ="stylesheet" type="text/css" href="css/bootstrap.min.css">
	    <link rel ="stylesheet" type="text/css" href="css/custom.css">
    </head>

 

    <body>
		<!-- interface -->
        <div navbar navbar-default navbar-fixed-top text-center><h1>BATTLESHIPS</h1></div>
        <h2 id="pseudo"></h2>
        <h3 id="infos"></h3>
        <div class="container container-fluid">
        <div class="row justify-content-between text-center">
        	<div class="col-lg-6">
			<!-- tableau adverse -->
			 <table>
			 <tbody id="adversaire">
			 <tr><td colspan=10>Votre adversaire</td></tr>
			  <tr><td></td><td>A</td><td>B</td><td>C</td><td>D</td><td>E</td><td>F</td><td>G</td><td>H</td><td>I</td></tr>
			  <tr id="test1"><td>1</td ><td id="test"> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td></tr>
			  <tr><td>2</td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td></tr>
			  <tr><td>3</td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td></tr>
			  <tr><td>4</td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td></tr>
			  <tr><td>5</td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td></tr>
			  <tr><td>6</td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td></tr>
			  <tr><td>7</td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td></tr>
			  <tr><td>8</td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td></tr>
			  <tr><td>9</td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td></tr>
			  <tr><td>10</td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td></tr>
			 </tbody>
			 </table>
		 </div>
		 <div class="col-lg-6">
		 <!-- tableau du joueur -->
			 <table >
			 <tbody id="joueur" >
			 <tr><td colspan=10>Votre jeu</td></tr>
			  <tr><td></td><td>A</td><td>B</td><td>C</td><td>D</td><td>E</td><td>F</td><td>G</td><td>H</td><td>I</td></tr>
			  <tr><td>1</td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td></tr>
			  <tr><td>2</td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td></tr>
			  <tr><td>3</td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td></tr>
			  <tr><td>4</td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td></tr>
			  <tr><td>5</td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td></tr>
			  <tr><td>6</td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td></tr>
			  <tr><td>7</td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td></tr>
			  <tr><td>8</td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td></tr>
			  <tr><td>9</td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td></tr>
			  <tr><td>10</td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td></tr>
			 </tbody>
			 </table>
		 </div>
		</div>
		</div>
		<div class="container container-fluid">
		<div class="row">
		<!-- sélection des bateaux -->
			<div class="col-lg-12 text-center">
				<h4>Vos bateaux:</h4>
					<select id="sel_bateau">
					  <option value="PA">Porte-avion (5)</option>
					  <option value="C">Croiseur (4)</option>
					  <option value="CT">Contre torpilleur (3)</option>
					  <option value="SM">Sous-marin (3)</option>
					  <option value="T">Torpilleur (2)</option>
					</select>
			</div>
		</div>
		</div>
		<div class="container container-fluid">
		<div class="row">
		<!-- Explications -->
			<div class="explications col-lg-12">
				<b><p>Pour jouer à Battleship:</p>
				<ul>
					<li>Il faut d'abord placer tous ses bateaux, pour faire ceci il faut cliquer sur une case pour placer le premier bout du bateau, puis cliquer sur une autre case pour placer le deuxième bout. Il faut que ces cases soient alignés, que le bateau qu'on essaie de placer ait un taille valide et que les bateaux ne se chevauchent pas.</li>
					<li>Vous pouvez sélectionner le bateau que vous voulez placer à l'aide de la liste déroulante.</li>
					<li>Une fois que tous vos bateaux sont placés la phase de tir démarre.</li>
					<li>Chaque joueur tir à son tour, pour tirer il suffit de cliquer sur la case de la grille adverse souhaitée.</li>
					<li>Si un bout de bateau est touché, alors la case se colore en vert, sinon elle se colore en bleu.</li>
					<li>Une fois que tous les bateaux d'un des joueurs ont été coulés, le jeu est terminé.</li>
				</ul>
				</b>
			</div>
		</div>
		</div>
        <script src="/socket.io/socket.io.js"></script>
		<script>
		var host = $(location).attr('host');
		var socket = io.connect(host); //on connecte le client au serveur
			console.log('connecté');
            var pseudo = prompt('Quel est votre pseudo ?'); //demande du pseudo
            var placement = true; // Pour savoir si on est en phase de placement ou pas
            var mon_tour = false; //pour savoir qui doit jouer dans la phase de tir
			var valeurs_bateaux=["PA","C","CT","SM","T"]; //tableaux des valeurs des bateaux
			
			//on récupère le signal 'premier' du serveur
            socket.on('premier',function(premier){
            	mon_tour = premier;
            });
            
			//on envoie la requête 'new user' avec le pseudo du joueur au serveur
            socket.emit('new_user', pseudo);
            alert('Veuillez placer vos bateaux');
            var nbrBateaux = 0;
			var listeBat= new Map; //dictionnaire pour savoir si les points du bateaux sont placés et les caractéristiques
			listeBat.set("PA", [5,0]);
			listeBat.set("C", [4,0]);
			listeBat.set("CT", [3,0]);
			listeBat.set("SM", [3,0]);
			listeBat.set("T", [2,0]);
			var room; //stockage de la salle dans laquelle est l'utilisateur
			
			var placement=true; //true si on est en phase de placement false sinon

			//on récupère le signal 'message'
			socket.on('message',function(message){
				alert(message);
			});
			
			//On garde en mémoire la room de l'utilisateur
			socket.on('chambre',function(chambre){
				room=chambre;
				alert(room);
			});
			
			
			//réinitialisation de la grille et des variables html
			socket.on('init',function(){
				alert('Veuillez placer vos bateaux');
				nbrBateaux = 0;
				listeBat= new Map; //dictionnaire pour savoir si les points du bateaux sont placés et les caractéristiques
				listeBat.set("PA", [5,0]);
				listeBat.set("C", [4,0]);
				listeBat.set("CT", [3,0]);
				listeBat.set("SM", [3,0]);
				listeBat.set("T", [2,0]);
				placement=true;
				for (var i=1;i<11;i++){
					for(var j =0;j<10;j++){
						$("#joueur tr:nth-child("+(i+2)+") td:nth-child("+(j+1)+")").css("background-color", 'transparent');
						$("#adversaire tr:nth-child("+(i+2)+") td:nth-child("+(j+1)+")").css("background-color", 'transparent');
					}
				}
				for (value of listeBat.keys()){
					if (!(value in valeurs_bateaux)){
						switch(value){
						case 'PA' :
							$('#sel_bateau').append('<option value='+value +' selected="selected">Porte-Avion (5)</option>');
							break;
						case 'C':
							$('#sel_bateau').append('<option value='+value +' selected="selected">Croiseur (4)</option>');
							break;
						case 'CT':
							$('#sel_bateau').append('<option value='+value +' selected="selected">Contre-Torpilleur (3)</option>');
							break;
						case 'SM' :
							$('#sel_bateau').append('<option value='+value +' selected="selected">Sous-marin (3)</option>');
							break;
						case 'T':
							$('#sel_bateau').append('<option value='+value +' selected="selected">Torpilleur (2)</option>');
							break;
						default :
							console.log("je ne connais pas ce bateau");
						}
					}
				}
			});

			//lorsqu'on clique :
            $('td').click(function (event) {
            	//$(event.target).css("background-color", "red");
            	var col = $(this).parent().children().index($(this));
				var row = $(this).parent().parent().children().index($(this).parent());
				var id = event.target.parentNode.parentNode.id;
				var val_bateau = $('#sel_bateau').val();


				console.log(id);
				console.log(placement);
				
				//si les bateaux ne sont pas encore placés :
				if (col>=1 && row>=2 && nbrBateaux<5) {

					if (id == 'joueur') {//si on est sur la grille du joueur
					//si c'est le premier bout du bateau
						if (listeBat.get(val_bateau)[1]==0){
							var aux_dico = listeBat.get(val_bateau);
							aux_dico[1]=1;
							aux_dico[2]=col;
							aux_dico[3]=row;
							listeBat.set(val_bateau, aux_dico);
							$("#"+id+" tr:nth-child("+(row+1)+") td:nth-child("+(col+1)+")").css("background-color", 'red');}
					// si c'est le second bout du bateau
						else if (listeBat.get(val_bateau)[1]==1){
							aux_dico = listeBat.get(val_bateau);
							//on regarde l'alignement des bateaux : horizontal ou vertical
							if (col==aux_dico[2]){
								if (Math.abs(row-aux_dico[3])==aux_dico[0]-1){
								// envoi des coordonnées des deux points au serveur, la valeur du bateau, le pseudo et la salle
									socket.emit('placement_bateaux', {"pseudo":pseudo,"id":id,"bateau":val_bateau,"col1":aux_dico[2],"row1":aux_dico[3],"col2":col,"row2":row,"room":room}); 

								}else {
									$("#infos").text("Le bout de votre bateau est mal placé !");
								}
							}
							else if (row==aux_dico[3]){
								if (Math.abs(col-aux_dico[2])==aux_dico[0]-1){
								// envoi des coordonnées des deux points au serveur, la valeur du bateau, le pseudo et la salle
									socket.emit('placement_bateaux', {"pseudo":pseudo,"id":id,"bateau":val_bateau,"col1":aux_dico[2],"row1":aux_dico[3],"col2":col,"row2":row,"room":room});

								}else {
									$("#infos").text("Le bout de votre bateau est mal placé !");
								}
							}else {
								$("#infos").text("Le bateau est de travers !");
							}
						//si on a déjà placé le bateau
						}else {
							$("#infos").text("bateau déjà placé");
						}
					}	
				}
				//si on a fini de placer les bateaux
				else if(col>=1 && row>=2){
					//si l'autre joueur n'a pas terminé
					if (placement){
						$("#infos").text("L'autre joueur n'a pas fini !");
					}else{ //si l'autre joueur a terminé
						if(id == 'adversaire' && mon_tour ){ //gestion de tour
							console.log('Hello');
							socket.emit('tir',{"pseudo":pseudo,"col":col,"row":row,'room':room}); //on envoie au serveur les coordonnées de la case sur laquelle on a tiré
							mon_tour = false;
							$("#infos").text("C'est au tour du joueur adverse de tirer");
						}
						else if(id == 'adversaire' && !mon_tour){
							$("#infos").text("Ce n'est pas à votre tour de jouer !");
							}
					}
				}
				else{
					$("#infos").text("Vous n'avez pas cliqué sur une case valide");
				}
            });
            
			//
            socket.on('welcome',function(message){
            	$('#pseudo').append(message);
            });

			//on colorie les cases si le placement du bateau était bon
            socket.on('retour_placement',function(placement){
				var bool=placement.bool;
				var val_bateau=placement.bateau;
				//si le placement était bon
				if (bool){
				//on enlève les bateaux déjà placés du select
					$("#sel_bateau option[value='"+val_bateau+"']").remove();
					valeurs_bateaux.splice(val_bateau);
					nbrBateaux = nbrBateaux + 1;
					var grille=placement.grille;
					var index = grille[0].indexOf(pseudo);
					//colorisation des cases
					for (var i=1;i<11;i++){
						for(var j =0;j<10;j++){
							if(grille[i][j][index] == 1){
								$("#joueur tr:nth-child("+(i+2)+") td:nth-child("+(j+1)+")").css("background-color", 'red');
							}
							else {
								$("#joueur tr:nth-child("+(i+2)+") td:nth-child("+(j+1)+")").css("background-color", 'transparent');
							}
						}
					}
					//si nbrBateaux >=5 on envoie le signal 'fin_placement' au serveur avec le pseudo et la salle
					if(nbrBateaux>=5){
						alert('vous avez fini de placer vos bateaux !');
						socket.emit("fin_placement",{"pseudo":pseudo,'room':room});
						if(mon_tour){
							$("#infos").text("C'est à votre tour de tirer");
						}
						else{
							$("#infos").text("C'est au tour de l'adversaire de tirer");
						}
					}
				} else {								//sinon on remet à 0 le nombre de points du bateaux mis
						if (val_bateau=="PA"){
							listeBat.set("PA", [5,0]);}
						else if (val_bateau=="C"){
							listeBat.set("C", [4,0]);}
						else if (val_bateau=="CT"){
							listeBat.set("CT", [3,0]);}
						else if (val_bateau=="SM"){
							listeBat.set("SM", [3,0]);}
						else{
							listeBat.set("T", [2,0]);}
					$("#infos").text("Vos bateaux sont les uns sur les autres");
				}
            });

			socket.on('retour_fin_placement',function(bool){
				placement = bool;
			});
			
			//gestion de tir
            socket.on('retour_tir',function(tirs){
				// s'il y a touche : message
            	if(tirs[tirs.length-1].touche){
            		$("#infos").text("Bien joué, vous avez touché un bateau !");
            	}
				//on colorie la grille adversaire selon les tirs (touchés ou pas)
            	for (var i=0;i<tirs.length;i++){
	            	var col = tirs[i].col+1;
	            	var row = tirs[i].row+1;
	            	var touche = tirs[i].touche;
	            	if(touche){
	            		$("#adversaire tr:nth-child("+row+") td:nth-child("+col+")").css("background-color", 'green');
	            	}else{
	            		$("#adversaire tr:nth-child("+row+") td:nth-child("+col+")").css("background-color", 'blue');
	            	}
            	}
            });

			//gestion de tir adversaire
            socket.on('retour_tir_adversaire',function(tirs){
			//si un bateau est touché, sa case est coloriée en vert
            	for (var i=0;i<tirs.length;i++){
	            	var col = tirs[i].col+1;
	            	var row = tirs[i].row+1;
	            	var touche = tirs[i].touche;
	            	if(touche){
	            		$("#joueur tr:nth-child("+row+") td:nth-child("+col+")").css("background-color", 'green');
	            	}
            	}
				//mise à jour de mon_tour
            	mon_tour = true;
            	$("#infos").text("C'est à votre tour de jouer.");
            })
			
			//message pour la victoire ou la défaite
            socket.on('gagne',function(message){
            	alert(message);
            });
            socket.on('perdu',function(message){
            	alert(message);
            });
        </script>

    </body>

</html>