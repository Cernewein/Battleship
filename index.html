<!DOCTYPE html>

<html>

    <head>

        <meta charset="utf-8" />

        <title>Battleships</title>
        <script src="https://code.jquery.com/jquery-3.1.1.js"
			  integrity="sha256-16cdPddA6VdVInumRGo6IbivbERE8p7CQR3HzTBuELA="
			  crossorigin="anonymous"></script>
	    <style type="text/css">
			@font-face {
				font-family: BG;
				src: url(BAD_GRUNGE.woff);

			}
			h1{
				font-family: BG;
				font-size: 100px;
				text-align: center;
				/*background-color: #222222;
				color: red;*/
			}
			h2{
				text-align: center;
			}
			td {
				height:20px;
				width: 20px;
				text-align: center;
			}
			table {
				width: 45%;
			}
			table, td, th {
				border: 1px solid black;
				border-collapse: collapse;
			}
	    </style>

    </head>

 

    <body>

        <h1>BATTLESHIPS</h1>
        <h2 id="pseudo"></h2>
        <!--<p><input type="button" value="Embêter le serveur" id="poke" /></p>-->

		 <table  align="left">
		 <tbody id="adversaire">
		 <tr><td colspan=10>Votre adversaire</td></tr>
		  <tr><td></td><td>A</td><td>B</td><td>C</td><td>D</td><td>E</td><td>F</td><td>G</td><td>H</td><td>I</td></tr>
		  <tr id="test1"><td>1</td ><td id="test"> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td></tr>
		  <tr><td>2</td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td></tr>
		  <tr><td>3</td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td></tr>
		  <tr><td>4</td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td></tr>
		  <tr><td>5</td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td></tr>
		  <tr><td>6</td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td></tr>
		  <tr><td>7</td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td></tr>
		  <tr><td>8</td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td></tr>
		  <tr><td>9</td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td></tr>
		  <tr><td>10</td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td></tr>
		 </tbody>
		 </table>

		 <table  align="right">
		 <tbody id="joueur" >
		 <tr><td colspan=10>Votre jeu</td></tr>
		  <tr><td></td><td>A</td><td>B</td><td>C</td><td>D</td><td>E</td><td>F</td><td>G</td><td>H</td><td>I</td></tr>
		  <tr><td>1</td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td></tr>
		  <tr><td>2</td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td></tr>
		  <tr><td>3</td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td></tr>
		  <tr><td>4</td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td></tr>
		  <tr><td>5</td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td></tr>
		  <tr><td>6</td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td></tr>
		  <tr><td>7</td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td></tr>
		  <tr><td>8</td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td></tr>
		  <tr><td>9</td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td></tr>
		  <tr><td>10</td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td></tr>
		 </tbody>
		 </table>

		<div align="center">
			<h3>Vos bateaux:</h3>
				<select id="sel_bateau">
				  <option value="PA">Porte-avion (5)</option>
				  <option value="C">Croiseur (4)</option>
				  <option value="CT">Contre torpilleur (3)</option>
				  <option value="SM">Sous-marin (3)</option>
				  <option value="T">Torpilleur (2)</option>
				</select>
		</div>

        <script src="/socket.io/socket.io.js"></script>
        <script>
            var socket = io.connect('http://localhost:8080');
			console.log('connecté');
            var pseudo = prompt('Quel est votre pseudo ?');
            var placement = true; // Pour savoir si on est en phase de placement ou pas
            var mon_tour = false;
			
            socket.on('premier',function(premier){
            	mon_tour = premier;
            });
            // Et on l'envoie avec le signal "new_user"

            socket.emit('new_user', pseudo);
            alert('Veuillez placer vos bateaux');
            var nbrBateaux = 0;
			var listeBat= new Map;
			listeBat.set("PA", [5,0]);
			listeBat.set("C", [4,0]);
			listeBat.set("CT", [3,0]);
			listeBat.set("SM", [3,0]);
			listeBat.set("T", [2,0]);
			var room;
			
			var placement=true;

			console.log(listeBat);
			
			socket.on('message',function(message){
				alert(message);
			});

			socket.on('chambre',function(chambre){
				room=chambre;
				alert(room);
			});

            $('td').click(function (event) {
            	//$(event.target).css("background-color", "red");
            	var col = $(this).parent().children().index($(this));
				var row = $(this).parent().parent().children().index($(this).parent());
				var id = event.target.parentNode.parentNode.id;
				var val_bateau = $('#sel_bateau').val();


				console.log(id);
				console.log(placement);
				
				if (col>=1 && row>=2 && nbrBateaux<5) {

					if (id == 'joueur') {//Gestion des bateaux à modifier ! Plutôt stocker toute la grille
					//si c'est le premier bout du bateau
						if (listeBat.get(val_bateau)[1]==0){
							var aux_dico = listeBat.get(val_bateau);
							aux_dico[1]=1;
							aux_dico[2]=col;
							aux_dico[3]=row;
							listeBat.set(val_bateau, aux_dico);
							$("#"+id+" tr:nth-child("+(row+1)+") td:nth-child("+(col+1)+")").css("background-color", 'red');}
					// si c'est le second bout du bateau
						else if (listeBat.get(val_bateau)[1]==1){
							aux_dico = listeBat.get(val_bateau);
							if (col==aux_dico[2]){
								if (Math.abs(row-aux_dico[3])==aux_dico[0]-1){
									socket.emit('placement_bateaux', {"pseudo":pseudo,"id":id,"bateau":val_bateau,"col1":aux_dico[2],"row1":aux_dico[3],"col2":col,"row2":row});

									//console.log(aux_dico);
									//console.log(row);
									//console.log(col);
								}else {
									alert("Le bout de votre bateau est mal placé !");
								}
							}
							else if (row==aux_dico[3]){
								if (Math.abs(col-aux_dico[2])==aux_dico[0]-1){
									socket.emit('placement_bateaux', {"pseudo":pseudo,"id":id,"bateau":val_bateau,"col1":aux_dico[2],"row1":aux_dico[3],"col2":col,"row2":row});

									//console.log(aux_dico);
									//console.log(row);
									//console.log(col);
								}else {
									alert("Le bout de votre bateau est mal placé !");
								}
							}else {
								alert('Le bateau est de travers !');
							}
						//si on a déjà placé le bateau
						}else {
						alert('bateau déjà placé');
						}
					}	
				}

				else {
					if (placement){
						alert('L autre joueur n a pas fini !')
					}else{
						if(id == 'adversaire' && mon_tour ){
							console.log('Hello');
							socket.emit('tir',{"pseudo":pseudo,"col":col,"row":row,'room':room});
							mon_tour = false;
						}
						else if(id == 'adversaire' && !mon_tour){
							alert("Ce n'est pas à votre tour de jouer !");
							}
					}
				}
				
            	//$('#joueur').css("background-color", "red");
            });
            /*$('td').click(function (event) {
            	//$(event.target).css("background-color", "red");
            	var col = $(this).parent().children().index($(this));
				var row = $(this).parent().parent().children().index($(this).parent());
				var id = event.target.parentNode.parentNode.id;
				if (col>=1 && row>=1) {
					socket.emit('cell', {"id":id,"col":col,"row":row});
				}
            	

            	//$('#joueur').css("background-color", "red");
            });*/
            socket.on('welcome',function(message){
            	$('#pseudo').append(message);
            });


            socket.on('retour_placement',function(placement){
				var bool=placement.bool;
				var val_bateau=placement.bateau;
				if (bool){
					$("#sel_bateau option[value='"+val_bateau+"']").remove();
					nbrBateaux = nbrBateaux + 1;
					var grille=placement.grille;
					var index = grille[0].indexOf(pseudo);
					for (var i=1;i<11;i++){
						for(var j =0;j<10;j++){
							if(grille[i][j][index] == 1){
								console.log('hello');
								$("#joueur tr:nth-child("+(i+2)+") td:nth-child("+(j+1)+")").css("background-color", 'red');
							}
							else {
								console.log('hola');
								$("#joueur tr:nth-child("+(i+2)+") td:nth-child("+(j+1)+")").css("background-color", 'white');
							}
						}
					}
					if(nbrBateaux>=5){
						alert('vous avez fini de placer vos bateaux !');
						socket.emit("fin_placement",{"pseudo":pseudo,'room':room});	
					}
				} else {
						if (val_bateau=="PA"){
							listeBat.set("PA", [5,0]);}
						else if (val_bateau=="C"){
							listeBat.set("C", [4,0]);}
						else if (val_bateau=="CT"){
							listeBat.set("CT", [3,0]);}
						else if (val_bateau=="SM"){
							listeBat.set("SM", [3,0]);}
						else{
							listeBat.set("T", [2,0]);}
					alert("Vos bateaux sont les uns sur les autres");
					
				}
            });

			socket.on('retour_fin_placement',function(bool){
				placement = bool;
			});
			
            socket.on('retour_tir',function(tirs){
            	if(tirs[tirs.length-1].touche){
            		alert('Bien joué, vous avez touché un bateau !');
            	}
            	for (var i=0;i<tirs.length;i++){
	            	var col = tirs[i].col+1;
	            	var row = tirs[i].row+1;
	            	var touche = tirs[i].touche;
	            	if(touche){
	            		$("#adversaire tr:nth-child("+row+") td:nth-child("+col+")").css("background-color", 'green');
	            	}else{
	            		$("#adversaire tr:nth-child("+row+") td:nth-child("+col+")").css("background-color", 'blue');
	            	}
            	}
            });

            socket.on('retour_tir_adversaire',function(tirs){
            	for (var i=0;i<tirs.length;i++){
	            	var col = tirs[i].col+1;
	            	var row = tirs[i].row+1;
	            	var touche = tirs[i].touche;
	            	if(touche){
	            		$("#joueur tr:nth-child("+row+") td:nth-child("+col+")").css("background-color", 'green');
	            	}
            	}
            	mon_tour = true;
            })

            socket.on('gagne',function(message){
            	alert(message);
            });
            socket.on('perdu',function(message){
            	alert(message);
            });
        </script>

    </body>

</html>